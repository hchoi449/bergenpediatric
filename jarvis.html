<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Jarvis - ThinkBigPrep</title>
    <meta name="description" content="Jarvis: your AI study assistant at ThinkBigPrep." />
    <link rel="shortcut icon" href="assets/logo/thinkbigprep-icon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="css/login.css?v=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
      body.jarvis{
        background: radial-gradient(120% 120% at 90% 0%, rgba(139,69,19,0.18) 0%, rgba(255,255,255,0) 58%), linear-gradient(135deg, #f7f2eb 0%, #ffffff 60%);
        min-height: 100vh;
        color: #1f2937;
      }
      .jarvis-shell{
        width: min(1120px, 94vw);
        margin: 120px auto 96px;
        display: flex;
        flex-direction: column;
        gap: 28px;
      }
      #jarvisApp{
        display: flex;
        flex-direction: column;
        gap: 28px;
      }
      .jarvis-nav{
        display: flex;
        align-items: center;
        gap: 22px;
        padding: 22px 26px;
        background: rgba(255,255,255,0.95);
        border-radius: 44px;
        border: 1px solid rgba(139,69,19,0.22);
        box-shadow: 0 36px 80px -20px rgba(90,56,28,0.55);
        backdrop-filter: blur(24px);
      }
      .jarvis-nav a{
        flex: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 24px 36px;
        border-radius: 32px;
        font-weight: 700;
        font-size: 1.15rem;
        color: #351f0a;
        text-decoration: none;
        transition: all .18s ease;
        position: relative;
      }
      .jarvis-nav a .bi{
        font-size: 1.2rem;
      }
      .jarvis-nav a:hover,
      .jarvis-nav a:focus-visible{
        background: rgba(139,69,19,0.08);
        outline: none;
      }
      .jarvis-nav a[aria-current="page"]{
        background: linear-gradient(135deg, #8B4513 0%, #a25a28 100%);
        color: #fff;
        box-shadow: 0 22px 36px -24px rgba(139,69,19,0.7);
      }
      .jarvis-nav a[aria-current="page"]:hover{
        background: linear-gradient(135deg, #7f3f12 0%, #9d5625 100%);
      }
      .jarvis-hero{
        padding: 34px 36px;
        border-radius: 30px;
        background: rgba(255,255,255,0.9);
        border: 1px solid rgba(139,69,19,0.16);
        box-shadow: 0 26px 80px -34px rgba(90,56,28,0.5);
        backdrop-filter: blur(18px);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .jarvis-hero-head{
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 24px;
      }
      .jarvis-hero-tag{
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        border-radius: 9999px;
        background: rgba(139,69,19,0.12);
        color: #8B4513;
        font-weight: 600;
        font-size: .85rem;
        letter-spacing: .04em;
        text-transform: uppercase;
      }
      .jarvis-hero-tag .bi{
        font-size: 1rem;
      }
      .jarvis-hero-title{
        font-size: 2.2rem;
        font-weight: 800;
        color: #3f2a11;
        margin: 10px 0 0;
      }
      .jarvis-hero-sub{
        margin: 10px 0 0;
        color: #6b5b4c;
        max-width: 640px;
        line-height: 1.6;
      }
      .jarvis-hero-metrics{
        display: flex;
        gap: 18px;
        align-items: flex-end;
        flex-wrap: wrap;
      }
      .jarvis-metric{
        display: flex;
        flex-direction: column;
        gap: 6px;
        background: linear-gradient(135deg, rgba(139,69,19,0.12), rgba(139,69,19,0.05));
        border: 1px solid rgba(139,69,19,0.12);
        border-radius: 18px;
        padding: 16px 18px;
        min-width: 160px;
      }
      .jarvis-metric-value{
        font-size: 1.9rem;
        font-weight: 700;
        color: #8B4513;
      }
      .jarvis-metric-label{
        text-transform: uppercase;
        font-size: .75rem;
        letter-spacing: .1em;
        color: #7c674d;
      }
      .jarvis-highlights{
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .jarvis-highlights li{
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 16px;
        background: rgba(139,69,19,0.08);
        color: #4b3115;
        font-weight: 600;
        font-size: .95rem;
      }
      .jarvis-highlights .bi{
        font-size: 1.05rem;
        color: #8B4513;
      }
      .ps-container{
        display: grid;
        grid-template-columns: minmax(0, 340px) minmax(0, 1fr);
        gap: 28px;
        align-items: stretch;
      }
      .ps-sidebar{
        position: sticky;
        top: 120px;
        align-self: flex-start;
        max-height: calc(100vh - 180px);
        overflow: auto;
        border: 1px solid rgba(139,69,19,0.14);
        border-radius: 24px;
        padding: 20px;
        background: rgba(255,255,255,0.92);
        box-shadow: 0 24px 60px -36px rgba(90,56,28,0.45);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .ps-sidebar::-webkit-scrollbar{
        width: 8px;
      }
      .ps-sidebar::-webkit-scrollbar-thumb{
        background: rgba(139,69,19,0.25);
        border-radius: 9999px;
      }
      .ps-exam-meta{
        margin: 0;
        padding: 18px;
        border: 1px solid rgba(139,69,19,0.16);
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(139,69,19,0.12), rgba(139,69,19,0.05));
        color: #4b3115;
      }
      .ps-exam-meta h3{
        margin: 0;
        font-size: 1.15rem;
        font-weight: 800;
        color: #4b3115;
      }
      .ps-exam-meta p{
        margin: 6px 0 0;
        font-size: .92rem;
        color: #6b5b4c;
      }
      #jarvisGuideActions{
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .ps-outline-empty{
        padding: 18px;
        border-radius: 16px;
        border: 1px dashed rgba(139,69,19,0.16);
        color: #7c674d;
        background: rgba(255,255,255,0.85);
        text-align: center;
        font-size: .95rem;
      }
      .ps-lesson-row{
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .ps-lesson{
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border: 1px solid rgba(139,69,19,0.18);
        border-radius: 16px;
        padding: 12px 14px;
        margin: 0;
        background: rgba(139,69,19,0.08);
        color: #4b3115;
        cursor: pointer;
        width: 100%;
        text-align: left;
        font: inherit;
        font-weight: 600;
        transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      }
      .ps-lesson::after{
        content: 'â€º';
        font-size: 1.1rem;
        font-weight: 700;
        color: currentColor;
        opacity: .65;
        transition: transform .18s ease;
      }
      .ps-lesson-row .ps-lesson{
        margin: 0;
        flex: 1;
      }
      .ps-lesson:hover::after{
        transform: translateX(2px);
      }
      .ps-lesson:hover,
      .ps-lesson:focus-visible{
        outline: none;
        transform: translateY(-1px);
        box-shadow: 0 14px 28px -20px rgba(90,56,28,0.55);
      }
      .ps-lesson.active{
        background: linear-gradient(135deg, #8B4513 0%, #a25a28 100%);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 18px 32px -22px rgba(139,69,19,0.7);
      }
      .ps-lesson.active::after{
        opacity: 0;
      }
      .ps-lesson-delete{
        border: 1px solid rgba(220,38,38,0.25);
        background: rgba(220,38,38,0.12);
        color: #991b1b;
        border-radius: 14px;
        padding: 8px 12px;
        font-size: .82rem;
        font-weight: 600;
        cursor: pointer;
        transition: background .18s ease, border-color .18s ease, color .18s ease;
      }
      .ps-lesson-delete:hover,
      .ps-lesson-delete:focus-visible{
        background: rgba(220,38,38,0.22);
        border-color: rgba(220,38,38,0.5);
        outline: none;
      }
      .ps-content{
        border-radius: 28px;
        padding: 30px;
        background: rgba(255,255,255,0.94);
        border: 1px solid rgba(139,69,19,0.1);
        box-shadow: 0 26px 70px -38px rgba(90,56,28,0.5);
        min-height: 460px;
        display: flex;
        flex-direction: column;
        gap: 18px;
        overflow: hidden;
      }
      .ps-breadcrumb{
        color: #7c674d;
        font-size: 2.25rem;
        text-transform: uppercase;
        letter-spacing: .1em;
      }
      .ps-title{
        font-size: 2.2rem;
        font-weight: 700;
        color: #2f1c08;
        margin: 0;
      }
      .ps-title.ps-title-main{
        font-size: 3.4rem;
        font-weight: 800;
        letter-spacing: .01em;
      }
      .ps-body{
        line-height: 1.7;
        color: #2f1c08;
      }
      .ps-question-title{
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0 0 10px;
        color: #2f1c08;
        text-align: center;
      }
      .ps-question-stem{
        font-size: 1.15rem;
        font-weight: 600;
        margin: 24px 0 12px;
        color: #3f2a11;
        text-align: center;
      }
      .ps-instruction{
        font-size: 1rem;
        color: #4b4b4b;
        margin: 0 0 75px;
        white-space: pre-wrap;
        font-weight: 600;
      }
      .ps-opts{
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 0;
        padding: 0;
      }
      .ps-opt{
        display: flex;
        align-items: flex-start;
        gap: 12px;
        border: 1px solid rgba(139,69,19,0.16);
        border-radius: 16px;
        padding: 14px 16px;
        background: rgba(139,69,19,0.06);
        color: #1f2937;
        cursor: pointer;
        text-align: left;
        width: 100%;
        transition: border-color .18s ease, background .18s ease, box-shadow .18s ease;
      }
      .ps-opt.sel{
        border-color: rgba(139,69,19,0.45);
        background: #fff;
        box-shadow: 0 16px 30px -26px rgba(139,69,19,0.6);
      }
      .ps-opt.correct{
        border-color: #16a34a;
        background: rgba(134,239,172,0.4);
        color: #14532d;
      }
      .ps-opt.wrong{
        border-color: #b91c1c;
        background: rgba(254,226,226,0.7);
        color: #7f1d1d;
      }
      .ps-opt-label{
        font-weight: 700;
        min-width: 24px;
      }
      .ps-explain{
        flex: 1;
        min-width: 0;
        white-space: pre-wrap;
      }
      .ps-q-nav{
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 18px;
      }
      .ps-q-nav button{
        min-width: 140px;
      }
      .ps-q-progress{
        font-weight: 700;
        color: #8B4513;
      }
      .ps-q-content{
        min-height: 280px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .ps-q-feedback{
        min-height: 24px;
        font-weight: 600;
      }
      .ps-q-actions{
        display: flex;
        flex-direction: column;
        gap: 14px;
        margin-top: 18px;
      }
      .ps-solution{
        margin-top: 18px;
        padding: 18px;
        border: 1px solid rgba(139,69,19,0.16);
        border-radius: 18px;
        background: rgba(139,69,19,0.06);
      }
      .ps-solution h4{
        margin: 0 0 8px;
        font-size: 1rem;
        color: #8B4513;
      }
      .ps-answer{
        margin-top: 14px;
        font-weight: 600;
        color: #4b5563;
      }
      .ps-answer-input{
        margin-top: 150px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .ps-answer-input label{
        font-weight: 600;
        color: #6b3410;
        font-size: .95rem;
      }
      .ps-answer-field{
        position: relative;
        display: block;
        width: 100%;
        border: 1px solid rgba(139,69,19,0.2);
        border-radius: 12px;
        padding: 12px 14px;
        min-height: 56px;
        background: #fff;
        transition: border-color .18s ease, box-shadow .18s ease;
        cursor: text;
      }
      .ps-answer-field.has-warning{
        border-color: #b45309;
        box-shadow: 0 0 0 1px rgba(180,83,9,0.25);
      }
      .ps-answer-editor{
        position: absolute;
        inset: 12px 14px;
        font-size: 1.05rem;
        line-height: 1.45;
        outline: none;
        white-space: pre-wrap;
        word-break: break-word;
        color: transparent;
        caret-color: #8B4513;
        background: transparent;
        z-index: 1;
      }
      .ps-answer-render{
        pointer-events: none;
        font-size: 1.05rem;
        line-height: 1.45;
        color: #1f2937;
        min-height: 28px;
        padding-right: 80px;
      }
      .ps-answer-warning{
        position: absolute;
        top: 6px;
        right: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #b45309;
        display: none;
        pointer-events: none;
      }
      .ps-answer-field.has-warning .ps-answer-warning{
        display: block;
      }
      .ps-answer-field.has-warning .ps-answer-render{
        color: #b45309;
      }
      @media (max-width: 1100px){
        .jarvis-shell{
          width: min(96vw, 980px);
        }
        .ps-container{
          gap: 22px;
        }
      }
      @media (max-width: 960px){
        .jarvis-shell{
          margin-top: 110px;
        }
        .ps-container{
          grid-template-columns: 1fr;
        }
        .ps-sidebar{
          position: relative;
          top: auto;
          max-height: none;
        }
      }
      @media (max-width: 720px){
        .jarvis-nav{
          flex-direction: column;
          align-items: stretch;
        }
        .jarvis-nav a{
          width: 100%;
        }
        .jarvis-hero{
          padding: 28px 24px;
        }
        .jarvis-hero-head{
          flex-direction: column;
          align-items: flex-start;
        }
        .jarvis-hero-title{
          font-size: 1.9rem;
        }
        .jarvis-highlights li{
          width: 100%;
          justify-content: flex-start;
        }
        .ps-content{
          padding: 24px;
        }
      }
      @media (max-width: 520px){
        .jarvis-shell{
          gap: 22px;
        }
        .jarvis-nav{
          padding: 8px;
        }
        .jarvis-metric{
          min-width: auto;
        }
      }
    </style>
  </head>
  <body class="jarvis">
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" aria-label="ThinkBigPrep Logo" style="text-decoration:none;color:inherit;">
          <img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" style="height:48px;width:auto;" />
        </a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="index.html#coaches">Available Tutors</a>
          <a href="about.html">About Us</a>
          <a href="jarvis.html" class="active">Jarvis</a>
          <a href="ai-curriculum.html">AI Curriculum</a>
          <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
      <nav class="nav-mobile" id="mobile-menu">
        <a href="index.html#home">Home</a>
        <a href="timetable.html">Timetable</a>
        <a href="index.html#courses">Plans</a>
        <a href="index.html#coaches">Available Tutors</a>
        <a href="about.html">About Us</a>
        <a href="jarvis.html" class="active">Jarvis</a>
        <a href="ai-curriculum.html">AI Curriculum</a>
        <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
      </nav>
    </header>

    <main class="jarvis-shell">
      <div id="jarvisApp">
        <nav class="jarvis-nav" aria-label="Jarvis navigation">
          <a href="jarvis.html" aria-current="page">
            <i class="bi bi-stars" aria-hidden="true"></i>
            <span>Study Guides</span>
          </a>
          <a href="jarvis-upload.html">
            <i class="bi bi-cloud-arrow-up" aria-hidden="true"></i>
            <span>Upload Worksheets</span>
          </a>
        </nav>

        <section class="jarvis-hero" aria-labelledby="jarvisTitle">
          <div class="jarvis-hero-head">
            <div>
              <span class="jarvis-hero-tag">
                <i class="bi bi-magic" aria-hidden="true"></i>
                AI-Powered
              </span>
              <h1 id="jarvisTitle" class="jarvis-hero-title">Jarvis</h1>
              <p class="jarvis-hero-sub">Your AI study assistant for fast summaries, practice questions, and explanations.</p>
            </div>
            <div class="jarvis-hero-metrics">
              <div class="jarvis-metric">
                <span class="jarvis-metric-value" id="jarvisGuideCount">0</span>
                <span class="jarvis-metric-label">Guides saved</span>
              </div>
              <div class="jarvis-metric">
                <span class="jarvis-metric-value" id="jarvisGuideRecent">â€”</span>
                <span class="jarvis-metric-label">Most recent upload</span>
              </div>
            </div>
          </div>
          <ul class="jarvis-highlights" role="list">
            <li><i class="bi bi-ui-checks-grid" aria-hidden="true"></i><span>Tailored practice question sets</span></li>
            <li><i class="bi bi-lightning-charge" aria-hidden="true"></i><span>Instant concept summaries</span></li>
            <li><i class="bi bi-chat-dots" aria-hidden="true"></i><span>Step-by-step feedback</span></li>
          </ul>
        </section>

        <section id="jarvisResults" class="ps-container">
          <aside class="ps-sidebar">
            <button type="button" id="jarvisMakeGuideBtn" class="btn btn-primary" style="width:100%;margin-bottom:14px;">Make a Study Guide</button>
            <div class="ps-exam-meta">
              <h3 id="jarvisExamTitle">Your Study Guides</h3>
              <p id="jarvisExamDate" style="display:none;"></p>
              <p id="jarvisExamDetails" style="display:none;"></p>
            </div>
            <div id="jarvisGuideActions" style="display:none;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
              <button type="button" id="jarvisClearGuidesBtn" class="btn btn-secondary" style="flex:1;">Clear All</button>
            </div>
            <div id="jarvisResultsOutline"></div>
            <div id="jarvisResultsEmpty" class="ps-outline-empty">Use "Make a Study Guide" to upload worksheets and populate this list.</div>
          </aside>
          <section class="ps-content">
            <div class="ps-breadcrumb" id="jarvisResultBreadcrumb">Your Study Guides</div>
            <h2 class="ps-title ps-title-main" id="jarvisResultTitle"></h2>
            <div class="ps-body" id="jarvisResultBody">
              <p class="ps-instruction">Upload a worksheet to generate tailored problems. They will appear here once ready.</p>
            </div>
          </section>
        </section>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" /><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Think Lab</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep Â© 2025</p></div>
      </div>
    </footer>

    <script>window.TBP_AUTH_BASE='https://cramprep.onrender.com';</script>
    <script src="index.js"></script>
    <script src="login.js?v=1.0"></script>
    <script>
      (function(){
        const makeGuideBtn = document.getElementById('jarvisMakeGuideBtn');
        const resultsOutline = document.getElementById('jarvisResultsOutline');
        const resultsEmpty = document.getElementById('jarvisResultsEmpty');
        const resultsExamTitle = document.getElementById('jarvisExamTitle');
        const resultsExamDate = document.getElementById('jarvisExamDate');
        const resultsBreadcrumb = document.getElementById('jarvisResultBreadcrumb');
        const resultsTitle = document.getElementById('jarvisResultTitle');
        const resultsBody = document.getElementById('jarvisResultBody');
        const resultsExamDetails = document.getElementById('jarvisExamDetails');
        const guideActions = document.getElementById('jarvisGuideActions');
        const clearGuidesBtn = document.getElementById('jarvisClearGuidesBtn');
        const guidesCountEl = document.getElementById('jarvisGuideCount');
        const guidesRecentEl = document.getElementById('jarvisGuideRecent');

        if (makeGuideBtn) makeGuideBtn.addEventListener('click', () => { window.location.href = 'jarvis-upload.html'; });

        function getAuthToken(){
          try { return localStorage.getItem('tbp_token') || ''; } catch { return ''; }
        }

        let storedGuides = [];
        const questionCache = {};
        const guidePositions = {};
        let currentGuideSlug = null;

        function loadStoredGuides(){
          try {
            const raw = localStorage.getItem('jarvisGuides');
            const arr = raw ? JSON.parse(raw) : [];
            if (!Array.isArray(arr)) return [];
            return arr.filter(g => g && g.slug).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
          } catch {
            return [];
          }
        }

        function formatExamDateLabel(iso){
          if (!iso) return '';
          const date = new Date(iso);
          if (Number.isNaN(date.getTime())) return '';
          return new Intl.DateTimeFormat(undefined, { weekday:'long', month:'short', day:'numeric' }).format(date);
        }

        function formatRecentLabel(iso){
          if (!iso) return '';
          const date = new Date(iso);
          if (Number.isNaN(date.getTime())) return '';
          const now = new Date();
          const diff = now.getTime() - date.getTime();
          const oneDay = 24 * 60 * 60 * 1000;
          if (diff < oneDay) return 'Today';
          if (diff < oneDay * 2) return 'Yesterday';
          return new Intl.DateTimeFormat(undefined, { month:'short', day:'numeric' }).format(date);
        }

        function formatGuideLabel(guide){
          const title = (guide.title || guide.slug || 'Study Guide').trim();
          const dateLabel = formatExamDateLabel(guide.examDate);
          return dateLabel ? `${title} â€” ${dateLabel}` : title;
        }

        function deleteGuide(slug){
          if (!slug) return;
          const guides = loadStoredGuides().filter(g => g.slug !== slug);
          try { localStorage.setItem('jarvisGuides', JSON.stringify(guides)); } catch {}
          const latest = localStorage.getItem('jarvisLatestGuide');
          if (latest === slug){
            if (guides.length) localStorage.setItem('jarvisLatestGuide', guides[0].slug);
            else localStorage.removeItem('jarvisLatestGuide');
          }
          delete questionCache[slug];
          delete guidePositions[slug];
          const wasCurrent = currentGuideSlug === slug;
          storedGuides = guides;
          if (wasCurrent){
            currentGuideSlug = guides.length ? guides[0].slug : null;
          }
          renderGuideList();
          if (currentGuideSlug){
            openGuide(currentGuideSlug);
          } else {
            Object.keys(questionCache).forEach(key => {
              if (!guides.some(g => g.slug === key)) delete questionCache[key];
            });
          }
          try { window.dispatchEvent(new CustomEvent('tbp:jarvis:guides-updated')); } catch {}
        }

        function clearAllGuides(){
          if (!storedGuides.length) return;
          const confirmClear = window.confirm('Delete all saved study guides? This cannot be undone.');
          if (!confirmClear) return;
          try {
            localStorage.removeItem('jarvisGuides');
            localStorage.removeItem('jarvisLatestGuide');
          } catch {}
          storedGuides = [];
          currentGuideSlug = null;
          Object.keys(questionCache).forEach(key => delete questionCache[key]);
          Object.keys(guidePositions).forEach(key => delete guidePositions[key]);
          renderGuideList();
          try { window.dispatchEvent(new CustomEvent('tbp:jarvis:guides-updated')); } catch {}
        }

        if (clearGuidesBtn){
          clearGuidesBtn.addEventListener('click', clearAllGuides);
        }

        function highlightSelected(){
          if (!resultsOutline) return;
          Array.from(resultsOutline.querySelectorAll('button[data-slug]')).forEach(btn => {
            btn.classList.toggle('active', btn.dataset.slug === currentGuideSlug);
          });
        }

        function updateMetaForGuide(guide, problemCount){
          if (!guide) return;
          const title = (guide.title || guide.slug || 'Study Guide').trim();
          const dateLabel = formatExamDateLabel(guide.examDate);
          if (resultsExamTitle) resultsExamTitle.textContent = title;
          if (resultsBreadcrumb) resultsBreadcrumb.textContent = title;
          if (resultsExamDate) {
            if (dateLabel) {
              resultsExamDate.textContent = dateLabel;
              resultsExamDate.style.display = '';
            } else {
              resultsExamDate.textContent = '';
              resultsExamDate.style.display = 'none';
            }
          }
          if (resultsExamDetails) {
            const details = [];
            if (guide.course) details.push(`Course: ${guide.course}`);
            if (guide.teacher) details.push(`Teacher: ${guide.teacher}`);
            if (guide.school) details.push(`School: ${guide.school}`);
            if (problemCount && problemCount > 0) details.push(`Problems: ${problemCount}`);
            if (details.length) {
              resultsExamDetails.textContent = details.join(' â€¢ ');
              resultsExamDetails.style.display = '';
            } else {
              resultsExamDetails.textContent = '';
              resultsExamDetails.style.display = 'none';
            }
          } else if (problemCount && problemCount > 0) {
            const label = `Problems: ${problemCount}`;
            if (resultsExamDetails) {
              resultsExamDetails.textContent = label;
              resultsExamDetails.style.display = '';
            }
          }
        }

        function updateGuideMetrics(guides){
          if (guidesCountEl){
            guidesCountEl.textContent = guides.length ? String(guides.length) : '0';
          }
          if (guidesRecentEl){
            if (guides.length){
              const recent = guides[0] || {};
              const label = formatRecentLabel(recent.createdAt || recent.updatedAt || recent.examDate) || 'Just now';
              guidesRecentEl.textContent = label;
            } else {
              guidesRecentEl.textContent = 'â€”';
            }
          }
        }

        function sanitizeQuestions(raw){
          if (!Array.isArray(raw)) return [];
          return raw
            .map(original => original || {})
            .map(original => {
              const question = { ...original };
              const options = Array.isArray(original.options) ? original.options : [];
              const cleanedOptions = [];
              let newCorrectIndex = -1;
              const originalCorrect = Number.isInteger(original.correct)
                ? Number(original.correct)
                : (Number.isInteger(original.answer_index) ? Number(original.answer_index) : -1);

              options.forEach((opt, idx) => {
                const text = formatDisplayText(opt);
                if (!text || !text.trim()) return;
                cleanedOptions.push(opt);
                if (idx === originalCorrect && newCorrectIndex < 0) {
                  newCorrectIndex = cleanedOptions.length - 1;
                }
              });

              if (cleanedOptions.length) {
                question.options = cleanedOptions;
                if (newCorrectIndex >= 0) {
                  question.correct = newCorrectIndex;
                  question.answer_index = newCorrectIndex;
                }
              } else {
                delete question.options;
              }

              const instruction = formatDisplayText(question.instruction || question.instructions || '').trim();
              const stem = formatDisplayText(
                question.stem_latex ||
                question.stem ||
                question.stimulus_latex ||
                question.stimulus_text ||
                question.promptLatex ||
                question.prompt ||
                question.question ||
                ''
              ).trim();
              const hasOptions = Array.isArray(question.options)
                ? question.options.some(opt => (formatDisplayText(opt) || '').trim())
                : false;
              const explanation = formatDisplayText(question.explanation || question.solution || '').trim();
              const imageUrl = question.imageUrl || question.image || question.pngUrl || '';

              if (!instruction) {
                question.instructions = 'Enter your simplified answer below.';
              }
              if (instruction || stem || hasOptions || explanation || imageUrl) {
                return question;
              }
              return null;
            })
            .filter(Boolean);
        }

        const MATH_FUNCTIONS = new Set(['sqrt','sin','cos','tan','ln','log','abs','root','frac']);

        const BP = Object.freeze({
          GROUP: 90,
          CALL: 80,
          UNARY: 80,
          IMPLICIT_CALL: 75,
          EXP: 70,
          IMPL_MULT: 65,
          MULT: 60,
          ADD: 50,
          COMPARE: 40
        });

        const CMP_LATEX = Object.freeze({
          '<': '<',
          '>': '>',
          '<=': '\\\\leq',
          '>=': '\\\\geq',
          '=': '=',
          '==': '=',
          '!=': '\\\\ne'
        });

        function tokenizeMath(input){
          const tokens = [];
          let i = 0;
          while (i < input.length){
            const ch = input[i];
            if (/\s/.test(ch)){ i++; continue; }
            if (/[0-9.]/.test(ch)){
              const start = i;
              while (i < input.length && /[0-9.]/.test(input[i])) i++;
              tokens.push({ type:'number', value: input.slice(start, i) });
              continue;
            }
            if (/[a-zA-Z]/.test(ch)){
              const start = i;
              while (i < input.length && /[a-zA-Z0-9_]/.test(input[i])) i++;
              tokens.push({ type:'ident', value: input.slice(start, i) });
              continue;
            }
            if (ch === '('){ tokens.push({ type:'lparen', value: ch }); i++; continue; }
            if (ch === ')'){ tokens.push({ type:'rparen', value: ch }); i++; continue; }
            if (ch === '{'){ tokens.push({ type:'lbrace', value: ch }); i++; continue; }
            if (ch === '}'){ tokens.push({ type:'rbrace', value: ch }); i++; continue; }
            if (ch === ','){ tokens.push({ type:'comma', value: ch }); i++; continue; }
            if (ch === '|'){ tokens.push({ type:'bar', value: ch }); i++; continue; }
            if (ch === '<' || ch === '>' || ch === '=' || ch === '!'){
              const two = input.slice(i, i + 2);
              if (two === '<=' || two === '>=' || two === '==' || two === '!='){
                tokens.push({ type:'cmp', value: two });
                i += 2;
                continue;
              }
              tokens.push({ type:'cmp', value: ch });
              i++;
              continue;
            }
            if ('+-*/^'.includes(ch)){
              tokens.push({ type:'op', value: ch });
              i++;
              continue;
            }
            throw new Error(`Unexpected character: ${ch}`);
          }
          tokens.push({ type:'eof', value:'' });
          return tokens;
        }

        function startsPrimary(tok){
          if (!tok) return false;
          return tok.type === 'number' ||
            tok.type === 'ident' ||
            tok.type === 'lparen' ||
            tok.type === 'lbrace' ||
            tok.type === 'bar';
        }

        function parseUserMath(str){
          const tokens = tokenizeMath(str);
          let pos = 0;

          const peek = (offset = 0) => tokens[Math.min(pos + offset, tokens.length - 1)];
          const consume = () => tokens[pos++];

          function cloneStop(stop){
            return stop ? new Set(stop) : null;
          }

          function nud(stopSet){
            const tok = consume();
            switch (tok.type){
              case 'number':
                return { type:'Number', value: tok.value };
              case 'ident':
                return { type:'Symbol', name: tok.value };
              case 'lparen': {
                const expr = parseExpr(0, stopSet);
                if (peek().type !== 'rparen') throw new Error('Expected )');
                consume();
                return { type:'Group', expr };
              }
              case 'lbrace': {
                const expr = parseExpr(0, stopSet);
                if (peek().type !== 'rbrace') throw new Error('Expected }');
                consume();
                return { type:'Group', expr };
              }
              case 'bar': {
                const nextStop = cloneStop(stopSet) || new Set();
                nextStop.add('bar');
                const expr = parseExpr(0, nextStop);
                if (peek().type !== 'bar') throw new Error('Unmatched |');
                consume();
                return { type:'Abs', expr };
              }
              case 'op':
                if (tok.value === '-' || tok.value === '+'){
                  const arg = parseExpr(BP.EXP - 1, stopSet);
                  return { type:'Unary', op: tok.value, arg };
                }
                break;
              default:
                break;
            }
            throw new Error('Unexpected token');
          }

          function lbp(op){
            switch (op){
              case '^': return BP.EXP;
              case '*':
              case '/': return BP.MULT;
              case '+':
              case '-': return BP.ADD;
              default: return 0;
            }
          }

          function parseComparisonChain(head, stopSet){
            const chain = [];
            while (true){
              const next = peek();
              if (next.type !== 'cmp') break;
              consume();
              const right = parseExpr(BP.COMPARE + 1, stopSet);
              chain.push({ op: next.value, right });
            }
            if (!chain.length) return head;
            return { type:'CompareChain', head, chain };
          }

          function parseExpr(minBP, stopSet){
            let left = nud(stopSet);

            while (true){
              const t = peek();
              if (stopSet && stopSet.has(t.type)) break;

              if (t.type === 'lparen' && left.type === 'Symbol'){
                if (BP.CALL < minBP) break;
                consume();
                const args = [];
                if (peek().type !== 'rparen'){
                  while (true){
                    args.push(parseExpr(0, stopSet));
                    if (peek().type === 'comma'){ consume(); continue; }
                    break;
                  }
                }
                if (peek().type !== 'rparen') throw new Error('Expected )');
                consume();
                left = { type:'Call', fn: left.name, args };
                continue;
              }

              if (left.type === 'Symbol' && MATH_FUNCTIONS.has(left.name.toLowerCase()) && startsPrimary(t)){
                if (BP.IMPLICIT_CALL < minBP) break;
                const arg = parseExpr(BP.MULT, stopSet);
                left = { type:'Call', fn: left.name, args:[ arg ], implicit:true };
                continue;
              }

              if (t.type === 'cmp'){
                if (BP.COMPARE < minBP) break;
                left = parseComparisonChain(left, stopSet);
                continue;
              }

              if (startsPrimary(t)){
                if (BP.IMPL_MULT < minBP) break;
                const right = parseExpr(BP.IMPL_MULT, stopSet);
                left = { type:'Binary', op:'*', left, right };
                continue;
              }

              if (t.type !== 'op') break;

              const op = t.value;
              let bpL;
              let bpR;
              if (op === '^'){
                bpL = BP.EXP;
                bpR = BP.EXP - 1;
              } else {
                bpL = lbp(op);
                bpR = lbp(op);
              }
              if (bpL < minBP) break;
              consume();
              const right = parseExpr(bpR, stopSet);
              left = { type:'Binary', op, left, right };
            }

            return left;
          }

          const ast = parseExpr(0, null);
          if (peek().type !== 'eof') throw new Error('Unexpected input');
          return ast;
        }

        function astToLatex(node){
          switch (node.type){
            case 'Number':
              return node.value;
            case 'Symbol':
              return node.name;
            case 'Unary': {
              const inner = astToLatex(node.arg);
              return `${node.op}${wrapForUnary(node.arg, inner)}`;
            }
            case 'Binary':
              return binaryToLatex(node);
            case 'Group':
              return `\\left(${astToLatex(node.expr)}\\right)`;
            case 'Abs':
              return `\\left|${astToLatex(node.expr)}\\right|`;
            case 'CompareChain': {
              const parts = [astToLatex(node.head)];
              for (const entry of node.chain){
                const latexOp = CMP_LATEX[entry.op] || entry.op;
                parts.push(`${latexOp} ${astToLatex(entry.right)}`);
              }
              return parts.join(' ');
            }
            case 'Call':
              return callToLatex(node);
            default:
              return '';
          }
        }

        function needsGroup(node){
          return (node.type === 'Binary' && (node.op === '+' || node.op === '-' || node.op === '*')) ||
            node.type === 'CompareChain';
        }

        function wrapForPower(node){
          const inner = astToLatex(node);
          if (node.type === 'Number' || node.type === 'Symbol') return inner;
          return `\\left(${inner}\\right)`;
        }

        function wrapForUnary(node, latex){
          if (node.type === 'Number' || node.type === 'Symbol' || node.type === 'Call') return latex;
          return `\\left(${latex}\\right)`;
        }

        function binaryToLatex(node){
          const left = astToLatex(node.left);
          const right = astToLatex(node.right);
          switch (node.op){
            case '+':
            case '-':
              return `${left} ${node.op} ${right}`;
            case '*': {
              const l = needsGroup(node.left) ? `\\left(${left}\\right)` : left;
              const r = needsGroup(node.right) ? `\\left(${right}\\right)` : right;
              return `${l}\\cdot ${r}`;
            }
            case '/':
              return `\\frac{${left}}{${right}}`;
            case '^':
              return `${wrapForPower(node.left)}^{${astToLatex(node.right)}}`;
            default:
              return `${left} ${node.op} ${right}`;
          }
        }

        function callToLatex(node){
          const args = node.args || [];
          const fnLower = typeof node.fn === 'string' ? node.fn.toLowerCase() : node.fn;
          switch (fnLower){
            case 'sqrt':
              return `\\sqrt{${astToLatex(args[0] || { type:'Number', value:'0' })}}`;
            case 'root':
              if (args.length >= 2) return `\\sqrt[${astToLatex(args[1])}]{${astToLatex(args[0])}}`;
              return `\\sqrt{${astToLatex(args[0] || { type:'Number', value:'0' })}}`;
            case 'frac':
              if (args.length >= 2) return `\\frac{${astToLatex(args[0])}}{${astToLatex(args[1])}}`;
              break;
            case 'abs':
              return `\\left|${astToLatex(args[0] || { type:'Number', value:'0' })}\\right|`;
            case 'log':
              if (args.length === 2) return `\\log_{${astToLatex(args[1])}}{${astToLatex(args[0])}}`;
              return `\\log\\left(${astToLatex(args[0] || { type:'Number', value:'0' })}\\right)`;
            default:
              if (typeof fnLower === 'string' && MATH_FUNCTIONS.has(fnLower)){
                return `\\${fnLower}\\left(${astToLatex(args[0] || { type:'Number', value:'0' })}\\right)`;
              }
              return `${node.fn}\\left(${args.map(astToLatex).join(', ')}\\right)`;
          }
          return astToLatex(args[0] || { type:'Number', value:'0' });
        }

        function renderGuideList(){
          if (!resultsOutline) return;
          storedGuides = loadStoredGuides();
          updateGuideMetrics(storedGuides);
          resultsOutline.innerHTML = '';
          if (guideActions){
            guideActions.style.display = storedGuides.length ? 'flex' : 'none';
          }
          if (clearGuidesBtn){
            clearGuidesBtn.disabled = storedGuides.length === 0;
          }
          if (!storedGuides.length){
            if (resultsEmpty) {
              resultsEmpty.style.display = '';
              resultsEmpty.textContent = 'Use "Make a Study Guide" to upload worksheets and populate this list.';
            }
            if (resultsExamTitle) resultsExamTitle.textContent = 'Your Study Guides';
            if (resultsExamDate) resultsExamDate.style.display = 'none';
            if (resultsExamDetails) resultsExamDetails.style.display = 'none';
            if (resultsBreadcrumb) resultsBreadcrumb.textContent = 'Your Study Guides';
            if (resultsTitle) resultsTitle.textContent = '';
            if (resultsBody) {
              resultsBody.innerHTML = '<p class="ps-instruction">Upload a worksheet to generate tailored problems. They will appear here once ready.</p>';
            }
            currentGuideSlug = null;
            highlightSelected();
            return;
          }

          if (resultsEmpty) resultsEmpty.style.display = 'none';
          storedGuides.forEach(guide => {
            const row = document.createElement('div');
            row.className = 'ps-lesson-row';
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'ps-lesson';
            btn.dataset.slug = guide.slug;
            btn.textContent = formatGuideLabel(guide);
            btn.addEventListener('click', () => openGuide(guide.slug));
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'ps-lesson-delete';
            delBtn.setAttribute('aria-label', `Delete ${guide.title || guide.slug}`);
            delBtn.textContent = 'Delete';
            delBtn.addEventListener('click', (event) => {
              event.stopPropagation();
              deleteGuide(guide.slug);
            });
            row.appendChild(btn);
            row.appendChild(delBtn);
            resultsOutline.appendChild(row);
          });
          highlightSelected();
        }

        function formatDisplayText(val){
          if (val === null || typeof val === 'undefined') return '';
          if (typeof val === 'string') return val;
          if (Array.isArray(val)) return val.map(formatDisplayText).join('\n');
          if (typeof val === 'object'){
            if (typeof val.latex === 'string' && val.latex.trim()) return val.latex;
            if (typeof val.text === 'string' && val.text.trim()) return val.text;
          }
          return String(val);
        }

        function maybeWrapLatex(input, forceMath){
          const str = (input || '').toString();
          const trimmed = str.trim();
          if (!trimmed) return '';

          const hasCommand = /\\[a-zA-Z]+/.test(trimmed);
          const hasGreek = /Ï€|Î¸|Î±|Î²|Î³|Î”|Î£|Î©|Âµ/.test(trimmed);
          const hasInequality = /[=<>]/.test(trimmed);
          const hasOperatorWithDigits = /[+\-*/^]/.test(trimmed) && /\d/.test(trimmed);
          const hasVariableNumber = /[a-zA-Z]\s*\d|\d\s*[a-zA-Z]/.test(trimmed);
          const hasVariableOps = /[a-zA-Z]\s*[+\-*/^]\s*[a-zA-Z]/.test(trimmed);
          const isNumeric = /^\d+(\.\d+)?$/.test(trimmed);
          const mathWord = /\b(?:sin|cos|tan|cot|sec|csc|log|ln|sqrt|pi|theta|sigma|delta|alpha|beta|gamma|phi|degree|deg|lim|mod)\b/i.test(trimmed);

          const looksLatex = hasCommand || hasGreek || hasInequality || hasOperatorWithDigits || hasVariableNumber || hasVariableOps || isNumeric || mathWord;
          if (!looksLatex) {
            if (!forceMath) return str;
            const pared = trimmed.replace(/[0-9+\-*/^=().,:%\s]/g, '');
            if (pared && !hasCommand) return str;
          }

          const withoutDelims = trimmed
            .replace(/^(\$\$?|\\\(|\\\[)/, '')
            .replace(/(\$\$?|\\\)|\\\])$/, '')
            .trim();

          const preferDisplay = /\\begin|\\displaystyle|\n/.test(withoutDelims);
          const left = preferDisplay ? '\\[' : '\\(';
          const right = preferDisplay ? '\\]' : '\\)';
          return `${left}${withoutDelims}${right}`;
        }

        function applyMath(el){
          try {
            if (window.renderMathInElement) {
              window.renderMathInElement(el, {
                delimiters: [
                  { left: '\\(', right: '\\)', display: false },
                  { left: '\\[', right: '\\]', display: true },
                  { left: '$$', right: '$$', display: true },
                  { left: '$', right: '$', display: false }
                ],
                throwOnError: false
              });
            }
          } catch (err) {
            console.warn('KaTeX render failed', err);
          }
        }

        function getProblemDisplayNumber(_question, fallback){
          return String(fallback);
        }

        function renderGuideContent(guide, questions){
          const safeQuestions = Array.isArray(questions) ? questions : [];
          updateMetaForGuide(guide, safeQuestions.length);
          if (!resultsBody) return;
          resultsBody.innerHTML = '';
          if (!safeQuestions.length){
            resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">No problems available yet for this study guide.</p>';
            return;
          }

          const total = safeQuestions.length;
          let index = Math.max(0, Math.min(Number.isInteger(guidePositions[guide.slug]) ? guidePositions[guide.slug] : 0, total - 1));
          guidePositions[guide.slug] = index;

          const viewer = document.createElement('div');
          viewer.className = 'ps-q-viewer';
          const nav = document.createElement('div');
          nav.className = 'ps-q-nav';
          const prevBtn = document.createElement('button');
          prevBtn.type = 'button';
          prevBtn.className = 'btn btn-secondary';
          prevBtn.textContent = 'Previous';
          const nextBtn = document.createElement('button');
          nextBtn.type = 'button';
          nextBtn.className = 'btn btn-secondary';
          nextBtn.textContent = 'Next';
          const progress = document.createElement('div');
          progress.className = 'ps-q-progress';
          nav.appendChild(prevBtn);
          nav.appendChild(progress);
          nav.appendChild(nextBtn);

          const content = document.createElement('div');
          content.className = 'ps-q-content';
          viewer.appendChild(nav);
          viewer.appendChild(content);
          resultsBody.appendChild(viewer);

          function updateNavState(){
            progress.textContent = `Problem ${index + 1} of ${total}`;
            prevBtn.disabled = total <= 1 || index === 0;
            nextBtn.disabled = total <= 1 || index === total - 1;
          }

          function setIndex(newIndex){
            index = Math.max(0, Math.min(newIndex, total - 1));
            guidePositions[guide.slug] = index;
            renderProblem();
          }

          function renderProblem(){
            updateNavState();
            const question = safeQuestions[index];
            content.innerHTML = '';
            if (!question){
              const empty = document.createElement('p');
              empty.className = 'ps-outline-empty';
              empty.style.border = 'none';
              empty.style.background = 'none';
              empty.style.padding = '0';
              empty.style.textAlign = 'left';
              empty.textContent = 'Problem unavailable.';
              content.appendChild(empty);
              return;
            }

            const card = document.createElement('article');
            card.className = 'ps-q-card';
            card.style.marginBottom = '0';
            content.appendChild(card);

            const instructionText = maybeWrapLatex(formatDisplayText(question.instruction || question.instructions || ''), false);
            if (instructionText){
              const instruct = document.createElement('p');
              instruct.className = 'ps-instruction';
              instruct.textContent = instructionText;
              card.appendChild(instruct);
            }

            const stemTextRaw = formatDisplayText(
              question.stem_latex ||
              question.stem ||
              question.stimulus_latex ||
              question.stimulus_text ||
              question.promptLatex ||
              question.prompt ||
              question.question ||
              ''
            );
            const stemText = maybeWrapLatex(stemTextRaw, true);
            if (stemText){
              const stem = document.createElement('p');
              stem.className = 'ps-question-stem';
              stem.textContent = stemText;
              stem.style.textAlign = 'center';
              card.appendChild(stem);
            }

            const imageUrl = question.imageUrl || question.image || question.pngUrl || '';
            if (imageUrl){
              const imgWrap = document.createElement('div');
              imgWrap.style.margin = '14px 0';
              imgWrap.style.textAlign = 'center';
              const img = document.createElement('img');
              img.src = imageUrl;
              img.alt = 'Worksheet reference';
              img.style.maxWidth = '100%';
              img.style.borderRadius = '12px';
              img.style.boxShadow = '0 8px 26px rgba(0,0,0,0.08)';
              imgWrap.appendChild(img);
              card.appendChild(imgWrap);
            }

            let selectedIdx = null;
            const optionButtons = [];

            const options = Array.isArray(question.options) ? question.options : [];
            if (options.length){
              const opts = document.createElement('div');
              opts.className = 'ps-opts';
              options.forEach((opt, optIdx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'ps-opt';
                btn.textContent = maybeWrapLatex(formatDisplayText(opt), true);
                btn.dataset.optionIndex = String(optIdx);
                btn.addEventListener('click', () => {
                  optionButtons.forEach(b => {
                    b.classList.remove('sel', 'correct', 'wrong');
                    b.setAttribute('aria-pressed', 'false');
                  });
                  btn.classList.add('sel');
                  btn.setAttribute('aria-pressed', 'true');
                  selectedIdx = optIdx;
                  feedback.textContent = '';
                  feedback.style.color = '';
                  actionBtn.textContent = 'Check';
                  actionBtn.dataset.mode = 'check';
                  solutionBox.style.display = 'none';
                });
                optionButtons.push(btn);
                opts.appendChild(btn);
              });
              card.appendChild(opts);
            }

            const feedback = document.createElement('div');
            feedback.className = 'ps-q-feedback';
            feedback.setAttribute('role', 'status');
            card.appendChild(feedback);

            const answerWrap = document.createElement('div');
            answerWrap.className = 'ps-answer-input';
            const answerLabel = document.createElement('label');
            answerLabel.textContent = 'Your Answer';
            answerWrap.appendChild(answerLabel);
            card.appendChild(answerWrap);

            const fieldShell = document.createElement('div');
            fieldShell.className = 'ps-answer-field';
            fieldShell.tabIndex = 0;
            fieldShell.setAttribute('role', 'group');
            fieldShell.setAttribute('aria-label', 'Answer input');
            fieldShell.setAttribute('aria-invalid', 'false');

            const editor = document.createElement('div');
            editor.className = 'ps-answer-editor';
            editor.contentEditable = 'true';
            editor.setAttribute('role', 'textbox');
            editor.setAttribute('aria-multiline', 'false');
            editor.setAttribute('aria-label', 'Answer input editor');

            const renderView = document.createElement('div');
            renderView.className = 'ps-answer-render';
            renderView.setAttribute('aria-live', 'polite');

            const warning = document.createElement('span');
            warning.className = 'ps-answer-warning';

            fieldShell.appendChild(editor);
            fieldShell.appendChild(renderView);
            fieldShell.appendChild(warning);
            answerWrap.appendChild(fieldShell);

            const hiddenLatex = document.createElement('input');
            hiddenLatex.type = 'hidden';
            hiddenLatex.name = `answerLatex-${guide.slug}-${index}`;
            answerWrap.appendChild(hiddenLatex);

            const hiddenRaw = document.createElement('input');
            hiddenRaw.type = 'hidden';
            hiddenRaw.name = `answerRaw-${guide.slug}-${index}`;
            answerWrap.appendChild(hiddenRaw);

            let rawValue = '';

            function placeCaretToEnd(el){
              try {
                const range = document.createRange();
                range.selectNodeContents(el);
                range.collapse(false);
                const sel = window.getSelection();
                if (sel){
                  sel.removeAllRanges();
                  sel.addRange(range);
                }
              } catch {}
            }

            function normaliseRaw(str){
              return String(str || '').replace(/\u00A0/g, ' ');
            }

            function updateRenderedState(){
              const trimmed = (rawValue || '').trim();
              hiddenRaw.value = rawValue;
              if (!trimmed){
                hiddenLatex.value = '';
                renderView.innerHTML = '';
                fieldShell.classList.remove('has-warning');
                warning.textContent = '';
                fieldShell.setAttribute('aria-invalid', 'false');
                if (document.activeElement === editor) placeCaretToEnd(editor);
                return;
              }
              try {
                const ast = parseUserMath(trimmed);
                const latex = astToLatex(ast);
                hiddenLatex.value = latex;
                renderView.innerHTML = `\\(${latex}\\)`;
                applyMath(renderView);
                fieldShell.classList.remove('has-warning');
                warning.textContent = '';
                fieldShell.setAttribute('aria-invalid', 'false');
              } catch (err){
                hiddenLatex.value = '';
                renderView.textContent = trimmed;
                warning.textContent = 'Unrecognized character';
                fieldShell.classList.add('has-warning');
                fieldShell.setAttribute('aria-invalid', 'true');
              }
              if (document.activeElement === editor) placeCaretToEnd(editor);
            }

            function enterEditing(){
              editor.textContent = rawValue;
              setTimeout(() => {
                editor.focus({ preventScroll: false });
                placeCaretToEnd(editor);
              }, 0);
            }

            function exitEditing(){
              rawValue = normaliseRaw(editor.textContent || '').replace(/\s+/g, ' ').trim();
              updateRenderedState();
            }

            fieldShell.addEventListener('focus', () => {
              enterEditing();
            });

            fieldShell.addEventListener('click', (event) => {
              if (document.activeElement !== editor){
                event.preventDefault();
                enterEditing();
              }
            });

            editor.addEventListener('input', () => {
              rawValue = normaliseRaw(editor.textContent || '');
              hiddenRaw.value = rawValue;
              updateRenderedState();
            });

            editor.addEventListener('keydown', (event) => {
              if (event.key === 'Enter'){
                event.preventDefault();
                editor.blur();
              } else if (event.key === 'Escape'){
                event.preventDefault();
                editor.textContent = rawValue;
                editor.blur();
              }
            });

            editor.addEventListener('blur', () => {
              exitEditing();
            });

            updateRenderedState();

            const actions = document.createElement('div');
            actions.className = 'ps-q-actions';
            actions.style.display = 'flex';
            actions.style.flexDirection = 'column';
            actions.style.gap = '12px';
            card.appendChild(actions);

            const actionBtn = document.createElement('button');
            actionBtn.type = 'button';
            actionBtn.className = 'btn btn-primary';
            actionBtn.textContent = 'Check';
            actionBtn.dataset.mode = 'check';
            actions.appendChild(actionBtn);

            const solutionBox = document.createElement('div');
            solutionBox.className = 'ps-solution';
            solutionBox.style.display = 'none';
            const solHeading = document.createElement('h4');
            solHeading.textContent = 'Solution';
            solutionBox.appendChild(solHeading);
            const solBody = document.createElement('p');
            solutionBox.appendChild(solBody);
            const answerLine = document.createElement('p');
            answerLine.className = 'ps-answer';
            solutionBox.appendChild(answerLine);
            card.appendChild(solutionBox);
            const correctIndex = Number.isInteger(question.correct) ? Number(question.correct) :
              Number.isInteger(question.answer_index) ? Number(question.answer_index) :
              (Array.isArray(options) ? 0 : -1);

            function revealSolution(){
              const explanation = maybeWrapLatex(formatDisplayText(question.explanation || question.solution || ''), false);
              const answerText = maybeWrapLatex(formatDisplayText(question.answer || (Array.isArray(options) ? options[correctIndex] : '')), true);
              if (explanation){
                solBody.textContent = explanation;
                solBody.style.display = '';
              } else {
                solBody.textContent = '';
                solBody.style.display = 'none';
              }
              if (answerText){
                answerLine.innerHTML = `Answer: ${answerText}`;
                answerLine.style.display = '';
              } else {
                answerLine.textContent = '';
                answerLine.style.display = 'none';
              }
              solutionBox.style.display = explanation || answerText ? '' : 'none';
              applyMath(solutionBox);
            }

            if (!options.length){
              revealSolution();
              actionBtn.disabled = true;
            }

            function handleCheck(){
              if (actionBtn.dataset.mode === 'next'){
                if (index < total - 1){
                  setIndex(index + 1);
                } else {
                  setIndex(0);
                }
                return;
              }
              if (!options.length){
                feedback.textContent = 'No answer choices available.';
                feedback.style.color = '#b45309';
                return;
              }
              if (selectedIdx === null){
                feedback.textContent = 'Please select an answer.';
                feedback.style.color = '#b45309';
                return;
              }
              const isCorrect = Number(correctIndex) === Number(selectedIdx);
              optionButtons.forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                const idx = Number(btn.dataset.optionIndex);
                if (isCorrect && idx === selectedIdx){
                  btn.classList.add('correct');
                } else if (!isCorrect && idx === selectedIdx){
                  btn.classList.add('wrong');
                }
              });
              if (isCorrect){
                feedback.textContent = 'Great job! That is correct.';
                feedback.style.color = '#065f46';
                actionBtn.textContent = index < total - 1 ? 'Next Problem' : 'Restart';
                actionBtn.dataset.mode = 'next';
                optionButtons.forEach(btn => btn.disabled = true);
                revealSolution();
              } else {
                feedback.textContent = 'Not quite. Try again.';
                feedback.style.color = '#b91c1c';
                actionBtn.textContent = 'Try Again';
                actionBtn.dataset.mode = 'check';
              }
            }

            actionBtn.addEventListener('click', handleCheck);
            applyMath(card);
          }

          prevBtn.addEventListener('click', () => {
            if (index > 0) setIndex(index - 1);
          });
          nextBtn.addEventListener('click', () => {
            if (index < total - 1) setIndex(index + 1);
          });

          renderProblem();
        }

        async function fetchGuideQuestions(slug){
          const base = (window.TBP_AUTH_BASE || '').replace(/\/$/, '');
          const token = getAuthToken();
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          const res = await fetch(`${base}/ai/agent2/questions?lesson=${encodeURIComponent(slug)}&ordered=1&n=200`, {
            headers
          });

          let data = null;
          let rawText = '';
          const contentType = res.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            data = await res.json().catch(() => null);
          } else {
            rawText = await res.text().catch(() => '');
          }

          if (res.ok && data && Array.isArray(data.questions)) {
            return data.questions;
          }

          const message = (data && (data.error || data.message)) || rawText || `Request failed (${res.status})`;
          const error = new Error(message || 'failed_to_load');
          error.status = res.status;
          error.payload = data || rawText;
          throw error;
        }

        async function openGuide(slug){
          if (!slug) return;
          storedGuides = loadStoredGuides();
          const guide = storedGuides.find(g => g.slug === slug);
          if (!guide) return;
          currentGuideSlug = slug;
          highlightSelected();
          updateMetaForGuide(guide);
          localStorage.setItem('jarvisLatestGuide', slug);
          if (!Number.isInteger(guidePositions[slug])) guidePositions[slug] = 0;

          if (questionCache[slug]) {
            renderGuideContent(guide, questionCache[slug]);
            return;
          }

          if (resultsBody) resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">Loading problemsâ€¦</p>';
          try {
            const questions = await fetchGuideQuestions(slug);
            const cleaned = sanitizeQuestions(questions);
            questionCache[slug] = cleaned;
            renderGuideContent(guide, cleaned);
          } catch (err) {
            console.warn('Failed to load guide', err);
            if (resultsBody) {
              let message = 'Unable to load problems for this guide.';
              if (err && (err.status === 401 || err.status === 403)) {
                message = 'Your session expired. Please log in again to view this study guide.';
              } else if (err && err.message) {
                message = `Unable to load problems for this guide. ${err.message}`;
              }
              resultsBody.innerHTML = `<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">${message}</p>`;
            }
          }
        }

        function init(){
          renderGuideList();
          const params = new URLSearchParams(window.location.search);
          const initialSlug = params.get('guide') || localStorage.getItem('jarvisLatestGuide');
          if (initialSlug) openGuide(initialSlug);
        }

        window.addEventListener('tbp:jarvis:guides-updated', renderGuideList);
        window.addEventListener('storage', function(e){
          if (e && e.key === 'jarvisGuides') renderGuideList();
        });

        init();
      })();
    </script>
  </body>
</html>
